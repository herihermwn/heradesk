generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS TABLE
// ============================================
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         UserRole
  avatarUrl    String?  @map("avatar_url")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  csStatus        CsStatus?
  assignedChats   ChatSession[]    @relation("AssignedCS")
  messages        Message[]
  cannedResponses CannedResponse[]
  activityLogs    ActivityLog[]

  @@map("users")
}

enum UserRole {
  admin
  cs
}

// ============================================
// CS STATUS TABLE (Online/Offline/Busy)
// ============================================
model CsStatus {
  userId       String   @id @map("user_id")
  status       CsState  @default(offline)
  maxChats     Int      @default(5) @map("max_chats")
  currentChats Int      @default(0) @map("current_chats")
  lastActiveAt DateTime @default(now()) @map("last_active_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cs_status")
}

enum CsState {
  online
  offline
  busy
}

// ============================================
// CHAT SESSIONS TABLE
// ============================================
model ChatSession {
  id String @id @default(cuid())

  // Anonymous customer info
  customerName  String? @map("customer_name")
  customerEmail String? @map("customer_email")
  customerToken String  @unique @map("customer_token")

  // Assignment
  assignedCsId String? @map("assigned_cs_id")

  // Status tracking
  status ChatStatus @default(waiting)

  // Metadata
  sourceUrl String? @map("source_url")
  userAgent String? @map("user_agent")
  ipAddress String? @map("ip_address")

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  assignedAt DateTime? @map("assigned_at")
  resolvedAt DateTime? @map("resolved_at")

  // Rating
  rating   Int?
  feedback String?

  // Relations
  assignedCs User?     @relation("AssignedCS", fields: [assignedCsId], references: [id])
  messages   Message[]

  @@index([status])
  @@index([assignedCsId])
  @@index([createdAt])
  @@map("chat_sessions")
}

enum ChatStatus {
  waiting
  active
  resolved
  abandoned
}

// ============================================
// MESSAGES TABLE
// ============================================
model Message {
  id        String @id @default(cuid())
  sessionId String @map("session_id")

  // Sender info
  senderType SenderType @map("sender_type")
  senderId   String?    @map("sender_id")

  // Content
  content     String
  messageType MessageType @default(text) @map("message_type")

  // Metadata
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender  User?       @relation(fields: [senderId], references: [id])

  @@index([sessionId])
  @@index([createdAt])
  @@map("messages")
}

enum SenderType {
  customer
  cs
  system
}

enum MessageType {
  text
  image
  file
  system
}

// ============================================
// CANNED RESPONSES (Quick replies for CS)
// ============================================
model CannedResponse {
  id        String   @id @default(cuid())
  title     String
  content   String
  shortcut  String?
  category  String?
  createdBy String?  @map("created_by")
  isGlobal  Boolean  @default(false) @map("is_global")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  creator User? @relation(fields: [createdBy], references: [id])

  @@map("canned_responses")
}

// ============================================
// ACTIVITY LOGS (For Admin)
// ============================================
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  action    String
  details   String?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}
